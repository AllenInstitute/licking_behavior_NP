import os
import sys
sys.path.append('/allen/programs/braintv/workgroups/nc-ophys/Doug/pbstools')
from pbstools import PythonJob 

python_file = r"/allen/programs/braintv/workgroups/nc-ophys/nick.ponvert/src/licking_behavior/scripts/nick/fit_training_history.py"

jobdir = '/allen/programs/braintv/workgroups/nc-ophys/nick.ponvert/cluster_jobs/20190708_fit_training_history'

job_settings = {'queue': 'braintv',
                'mem': '15g',
                'walltime': '24:00:00',
                'ppn':16,
                'jobdir': jobdir,
                }


#  All subjects
#  [795512663, 847074139, 847076515, 820871399, 823826963, 830896318,
#   834823464, 766015379, 830940312, 772629800, 784057617, 831004160,
#   830901414, 756674776, 772622642, 756577240, 760949537, 795522266,
#   744911447, 722884873, 791756316, 789992895, 842724844, 803258370,
#   843387577, 813703535, 814111925, 820878203]

#  subjects_to_use = [795512663]
#  subject_inds = [40, 41, 42, 43, 44, 45, 46, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57,
#  58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74,
#  75, 76, 77, 78, 79]

# Debug
subject_inds = [81]

# The next 300 inds
#  subject_inds = [  81,   83,   84,   85,   86,   87,   88,   89,   90,   91,   92,
#           93,   94,   95,   96,   97,   98,   99,  100,  101,  102,  103,
#          104,  105,  106,  107,  108,  109,  110,  111,  112,  113,  208,
#          209,  210,  211,  212,  213,  214,  215,  216,  217,  218,  219,
#          220,  221,  222,  223,  224,  225,  226,  227,  228,  229,  230,
#          231,  232,  233,  234,  235,  236,  237,  238,  239,  326,  327,
#          329,  330,  331,  332,  333,  334,  335,  337,  338,  339,  340,
#          341,  342,  343,  344,  345,  346,  347,  348,  349,  350,  351,
#          352,  353,  354,  355,  356,  357,  358,  359,  360,  446,  447,
#          448,  449,  450,  451,  452,  453,  455,  456,  457,  458,  459,
#          460,  461,  462,  463,  464,  465,  466,  467,  468,  469,  470,
#          471,  472,  473,  474,  475,  476,  966,  967,  968,  969,  970,
#          971,  972,  973,  974,  975,  976,  977,  978,  979,  980,  981,
#          982,  983,  984,  985,  986,  987,  988,  989,  990,  991,  992,
#          993,  994,  995,  996,  997,  998,  999, 1000, 1001, 1002, 1003,
#         1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014,
#         1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1024, 1025, 1026,
#         1027, 1028, 1029, 1030, 1031, 1032, 1033, 1034, 1035, 1036, 1037,
#         1038, 1039, 1040, 1041, 1042, 1043, 1044, 1045, 1046, 1047, 1048,
#         1049, 1050, 1051, 1052, 1053, 1054, 1055, 1056, 1057, 1058, 1059,
#         1060, 1062, 1063, 1064, 1065, 1066, 1067, 1068, 1069, 1070, 1071,
#         1072, 1073, 1074, 1075, 1076, 1077, 1078, 1079, 1080, 1081, 1082,
#         1083, 1084, 1085, 1086, 1087, 1088, 1089, 1090, 1091, 1092, 1093,
#         1094, 1095, 1096, 1097, 1100, 1101, 1102, 1103, 1104, 1105, 1106,
#         1107, 1108, 1111, 1112, 1113, 1114, 1115, 1116, 1117, 1118, 1119,
#         1120, 1121, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1130,
#         1131, 1132, 1133, 1134, 1135, 1136, 1137, 1138, 1225, 1226, 1227,
#         1228, 1229, 1230, 1231]

#  vb_sessions = pd.read_hdf('/home/nick.ponvert/nco_home/data/vb_sessions.h5', key='df')
#  sessions_to_use = vb_sessions[vb_sessions['stage_name'] != 'Load error']
#  subjects_to_use = [847074139, 847076515, 820871399, 823826963, 830896318]
#  subject_sessions = sessions_to_use.query('donor_id in @subjects_to_use')

for row_loc in subject_inds:
    PythonJob(
        python_file,
        python_executable='/home/nick.ponvert/.conda/envs/visb/bin/python',
        python_args=row_loc,
        conda_env=None,
        jobname = 'licking_model_loc{}'.format(row_loc),
        **job_settings
    ).run(dryrun=False)
